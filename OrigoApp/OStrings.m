//
//  OStrings.m
//  OrigoApp
//
//  Created by Anders Blehr on 17.10.12.
//  Copyright (c) 2012 Rhelba Creations. All rights reserved.
//

#import "OStrings.h"

// Cross-view terms & strings
NSString * const strFooterTapToEdit                  = @"strFooterTapToEdit";
NSString * const strFooterOrigoSignature             = @"strFooterOrigoSignature";
NSString * const strButtonOK                         = @"strButtonOK";
NSString * const strButtonEdit                       = @"strButtonEdit";
NSString * const strButtonNext                       = @"strButtonNext";
NSString * const strButtonDone                       = @"strButtonDone";
NSString * const strButtonContinue                   = @"strButtonContinue";
NSString * const strButtonCancel                     = @"strButtonCancel";
NSString * const strButtonSignOut                    = @"strButtonSignOut";
NSString * const strAlertTextNoInternet              = @"strAlertTextNoInternet";
NSString * const strAlertTextServerError             = @"strAlertTextServerError";
NSString * const strAlertTextLocating                = @"strAlertTextLocating";
NSString * const strTermYes                          = @"strTermYes";
NSString * const strTermNo                           = @"strTermNo";
NSString * const strTermMan                          = @"strTermMan";
NSString * const strTermBoy                          = @"strTermBoy";
NSString * const strTermWoman                        = @"strTermWoman";
NSString * const strTermGirl                         = @"strTermGirl";
NSString * const strFormatAge                        = @"strFormatAge";
NSString * const strSeparatorAnd                     = @"strSeparatorAnd";

// OAuthView strings
NSString * const strLabelSignIn                      = @"strLabelSignIn";
NSString * const strLabelActivate                    = @"strLabelActivate";
NSString * const strFooterSignInOrRegister           = @"strFooterSignInOrRegister";
NSString * const strFooterActivateUser               = @"strFooterActivateUser";
NSString * const strFooterActivateEmail              = @"strFooterActivateEmail";
NSString * const strPlaceholderAuthEmail             = @"strPlaceholderAuthEmail";
NSString * const strPlaceholderPassword              = @"strPlaceholderPassword";
NSString * const strPlaceholderActivationCode        = @"strPlaceholderActivationCode";
NSString * const strPlaceholderRepeatPassword        = @"strPlaceholderRepeatPassword";
NSString * const strPlaceholderPleaseWait            = @"strPlaceholderPleaseWait";
NSString * const strButtonHaveCode                   = @"strButtonHaveCode";
NSString * const strButtonStartOver                  = @"strButtonStartOver";
NSString * const strAlertTitleActivationFailed       = @"strAlertTitleActivationFailed";
NSString * const strAlertTextActivationFailed        = @"strAlertTextActivationFailed";
NSString * const strAlertTitleWelcomeBack            = @"strAlertTitleWelcomeBack";
NSString * const strAlertTextWelcomeBack             = @"strAlertTextWelcomeBack";

// OOrigoListView strings
NSString * const strViewTitleOrigo                   = @"strViewTitleOrigo";
NSString * const strHeaderWardsOrigos                = @"strHeaderWardsOrigos";
NSString * const strHeaderMyOrigos                   = @"strHeaderMyOrigos";
NSString * const strFooterOrigoCreationFirst         = @"strFooterOrigoCreationFirst";
NSString * const strFooterOrigoCreation              = @"strFooterOrigoCreation";
NSString * const strFooterOrigoCreationWards         = @"strFooterOrigoCreationWards";
NSString * const strButtonCountryLocate              = @"strButtonCountryLocate";
NSString * const strButtonCountryOther               = @"strButtonCountryOther";
NSString * const strAlertTitleListedUserRegistration = @"strAlertTitleListedUserRegistration";
NSString * const strAlertTextListedUserRegistration  = @"strAlertTextListedUserRegistration";
NSString * const strAlertTitleIncompleteRegistration = @"strAlertTitleIncompleteRegistration";
NSString * const strAlertTextIncompleteRegistration  = @"strAlertTextIncompleteRegistration";
NSString * const strAlertTitleCountryOther           = @"strAlertTitleCountryOther";
NSString * const strAlertTextCountryOther            = @"strAlertTextCountryOther";
NSString * const strAlertTextCountrySupported        = @"strAlertTextCountrySupported";
NSString * const strAlertTextCountryUnsupported      = @"strAlertTextCountryUnsupported";
NSString * const strSheetTitleCountry                = @"strSheetTitleCountry";
NSString * const strSheetTitleOrigoType              = @"strSheetTitleOrigoType";
NSString * const strTermYourChild                    = @"strTermYourChild";
NSString * const strTermHimOrHer                     = @"strTermHimOrHer";
NSString * const strTermForName                      = @"strTermForName";

// OOrigoView strings
NSString * const strDefaultResidenceName             = @"strDefaultResidenceName";
NSString * const strLabelAddress                     = @"strLabelAddress";
NSString * const strLabelPurpose                     = @"strLabelPurpose";
NSString * const strLabelDescriptionText             = @"strLabelDescriptionText";
NSString * const strLabelTelephone                   = @"strLabelTelephone";
NSString * const strPlaceholderAddress               = @"strPlaceholderAddress";
NSString * const strPlaceholderDescriptionText       = @"strPlaceholderDescriptionText";
NSString * const strPlaceholderTelephone             = @"strPlaceholderTelephone";
NSString * const strButtonAbout                      = @"strButtonAbout";
NSString * const strButtonShowInMap                  = @"strButtonShowInMap";
NSString * const strButtonNewHousemate               = @"strButtonNewHousemate";
NSString * const strButtonOtherGuardian              = @"strButtonOtherGuardian";
NSString * const strButtonDeleteMember               = @"strButtonDeleteMember";

// OMemberView strings
NSString * const strViewTitleAboutMe                 = @"strViewTitleAboutMe";
NSString * const strLabelDateOfBirth                 = @"strLabelDateOfBirth";
NSString * const strLabelMobilePhone                 = @"strLabelMobilePhone";
NSString * const strLabelEmail                       = @"strLabelEmail";
NSString * const strPlaceholderPhoto                 = @"strPlaceholderPhoto";
NSString * const strPlaceholderName                  = @"strPlaceholderName";
NSString * const strPlaceholderDateOfBirth           = @"strPlaceholderDateOfBirth";
NSString * const strPlaceholderMobilePhone           = @"strPlaceholderMobilePhone";
NSString * const strPlaceholderEmail                 = @"strPlaceholderEmail";
NSString * const strFooterOrigoInviteAlert           = @"strFooterOrigoInviteAlert";
NSString * const strFooterJuvenileOrigoGuardian      = @"strFooterJuvenileOrigoGuardian";
NSString * const strButtonParentToSome               = @"strButtonParentToSome";
NSString * const strButtonAddAddress                 = @"strButtonAddAddress";
NSString * const strButtonChangePassword             = @"strButtonChangePassword";
NSString * const strButtonEditRelations              = @"strButtonEditRelations";
NSString * const strButtonCorrectGender              = @"strButtonCorrectGender";
NSString * const strButtonNewAddress                 = @"strButtonNewAddress";
NSString * const strButtonAllContacts                = @"strButtonAllContacts";
NSString * const strButtonInviteToHousehold          = @"strButtonInviteToHousehold";
NSString * const strButtonMergeHouseholds            = @"strButtonMergeHouseholds";
NSString * const strAlertTitleMemberExists           = @"strAlertTitleMemberExists";
NSString * const strAlertTextMemberExists            = @"strAlertTextMemberExists";
NSString * const strAlertTitleUserEmailChange        = @"strAlertTitleUserEmailChange";
NSString * const strAlertTextUserEmailChange         = @"strAlertTextUserEmailChange";
NSString * const strAlertTitleEmailChangeFailed      = @"strAlertTitleFailedEmailChange";
NSString * const strAlertTextEmailChangeFailed       = @"strAlertTextFailedEmailChange";
NSString * const strSheetTitleEmailRecipient         = @"strSheetTitleEmailRecipient";
NSString * const strSheetTitleTextRecipient          = @"strSheetTitleTextRecipient";
NSString * const strSheetTitlePhoneCallRecipient     = @"strSheetTitlePhoneCallRecipient";
NSString * const strSheetTitleExistingResidence      = @"strSheetTitleExistingResidence";
NSString * const strQuestionArgumentGender           = @"strQuestionArgumentGender";
NSString * const strQuestionArgumentGenderMinor      = @"strQuestionArgumentGenderMinor";
NSString * const strTermHisFather                    = @"strTermHisFather";
NSString * const strTermHerFather                    = @"strTermHerFather";
NSString * const strTermHisMother                    = @"strTermHisMother";
NSString * const strTermHerMother                    = @"strTermHerMother";

// OCalendarView strings
NSString * const strViewTitleCalendar                = @"strViewTitleCalendar";

// OTaskListView strings
NSString * const strViewTitleTasks                   = @"strViewTitleTasks";

// OMessageListView strings
NSString * const strViewTitleMessages                = @"strViewTitleMessages";
NSString * const strDefaultMessageBoardName          = @"strDefaultMessageBoardName";

// OSettingListView strings
NSString * const strViewTitleSettings                = @"strViewTitleSettings";

// OSettingView strings
NSString * const strLabelCountrySettings             = @"strLabelCountrySettings";
NSString * const strLabelCountryLocation             = @"strLabelCountryLocation";
NSString * const strFooterCountryInfo                = @"strFooterCountryInfo";
NSString * const strFooterCountryInfoNote            = @"strFooterCountryInfoNote";
NSString * const strFooterCountryInfoLocate          = @"strFooterCountryInfoLocate";

// Origo type strings
NSString * const kOrigoLabelTypeOrigo                = @"strOrigoLabel";
NSString * const kOrigoLabelTypeOrigoNew             = @"strNewOrigoLabel";
NSString * const kOrigoLabelTypeMemberList           = @"strMemberListLabel";
NSString * const kOrigoLabelTypeMemberNew            = @"strNewMemberLabel";

// Meta strings
NSString * const metaSupportedCountryCodes           = @"metaSupportedCountryCodes";
NSString * const metaContactRolesSchoolClass         = @"metaContactRolesSchoolClass";
NSString * const metaContactRolesPreschoolClass      = @"metaContactRolesPreschoolClass";
NSString * const metaContactRolesOrganisation         = @"metaContactRolesAssociation";
NSString * const metaContactRolesSportsTeam          = @"metaContactRolesSportsTeam";

static NSDictionary const *strings = nil;
static NSString * const kStringsPlist = @"strings.plist";
static NSInteger const kDaysBetweenStringFetches = 0; // TODO: Set to 14

static NSString * const kKeyPrefixLabel = @"strLabel";
static NSString * const kKeyPrefixPlaceholder = @"strPlaceholder";
static NSString * const kKeyPrefixFooter = @"strFooter";
static NSString * const kKeyPrefixAddMemberButton = @"strButtonAddMember";
static NSString * const kKeyPrefixAddContactButton = @"strButtonAddContact";
static NSString * const kKeyPrefixContactRole = @"strContactRole";
static NSString * const kKeyPrefixSettingTitle = @"strSettingTitle";
static NSString * const kKeyPrefixSettingText = @"strSettingText";


@implementation OStrings

#pragma mark - Auxiliary methods

+ (NSString *)pathToStringsFile
{
    NSString *cachesDirectory = NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES)[0];
    NSString *relativePath = [kBundleId stringByAppendingPathComponent:kStringsPlist];
    
    return [cachesDirectory stringByAppendingPathComponent:relativePath];
}


#pragma mark - String fetching & refresh

+ (BOOL)hasStrings
{
    if (!strings) {
        strings = [NSDictionary dictionaryWithContentsOfFile:[self pathToStringsFile]];
    }
    
    return (strings != nil);
}


+ (void)refreshIfNeeded
{
    if ([[OMeta m] userIsSignedIn] && [[OMeta m] internetConnectionIsAvailable]) {
        NSDate *stringDate = [ODefaults globalDefaultForKey:kDefaultsKeyStringDate];
        
        if (!stringDate || ([stringDate daysBeforeNow] >= kDaysBetweenStringFetches)) {
            [OConnection fetchStrings];
        }
    }
}


#pragma mark - Display strings

+ (NSString *)stringForKey:(NSString *)key
{
    NSString *string = @"";
    
    if ([self hasStrings]) {
        string = strings[key];
        
        if (!string) {
            OLogBreakage(@"No string with key '%@'.", key);
        }
    } else {
        OLogError(@"Failed to read strings from file.");
    }
    
    return string;
}


+ (NSString *)labelForKey:(NSString *)key
{
    return [self stringForKey:[kKeyPrefixLabel stringByAppendingCapitalisedString:key]];
}


+ (NSString *)placeholderForKey:(NSString *)key
{
    return [self stringForKey:[kKeyPrefixPlaceholder stringByAppendingCapitalisedString:key]];
}


+ (NSString *)labelForOrigoType:(NSString *)origoType labelType:(NSString *)labelType
{
    return [OStrings stringForKey:[labelType stringByAppendingCapitalisedString:origoType]];
}


+ (NSString *)footerForOrigoType:(NSString *)origoType
{
    return [OStrings stringForKey:[kKeyPrefixFooter stringByAppendingCapitalisedString:origoType]];
}


+ (NSString *)addMemberButtonTitleForOrigoType:(NSString *)origoType
{
    return [OStrings stringForKey:[kKeyPrefixAddMemberButton stringByAppendingCapitalisedString:origoType]];
}


+ (NSString *)addContactButtonTitleForOrigoType:(NSString *)origoType
{
    return [OStrings stringForKey:[kKeyPrefixAddContactButton stringByAppendingCapitalisedString:origoType]];
}


+ (NSString *)titleForContactRole:(NSString *)contactRole
{
    return [self stringForKey:[kKeyPrefixContactRole stringByAppendingCapitalisedString:contactRole]];
}


+ (NSString *)titleForSettingKey:(NSString *)settingKey
{
    return [self stringForKey:[kKeyPrefixSettingTitle stringByAppendingCapitalisedString:settingKey]];
}


+ (NSString *)labelForSettingKey:(NSString *)settingKey
{
    return [self stringForKey:[kKeyPrefixSettingText stringByAppendingCapitalisedString:settingKey]];
}


#pragma mark - OConnectionDelegate conformance

+ (void)didCompleteWithResponse:(NSHTTPURLResponse *)response data:(id)data
{
    if (response.statusCode == kHTTPStatusOK) {
        strings = data;
        
        if ([strings writeToFile:[self pathToStringsFile] atomically:YES]) {
            [ODefaults setGlobalDefault:[NSDate date] forKey:kDefaultsKeyStringDate];
            OLogDebug(@"Wrote latest strings to file.");
        } else {
            OLogError(@"Error writing latest strings to file.");
        }
    } else {
        OLogError(@"Error retrieving latest strings from server.");
    }
}


+ (void)didFailWithError:(NSError *)error
{
    [[OState s].viewController didFailWithError:error];
}

@end
